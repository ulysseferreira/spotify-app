<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Random</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="root"></div>

<!-- React -->
<script src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21"></script>


<!-- Babel for JSX transformation -->
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

<script type="text/babel">
  class App extends React.Component {
    constructor(props) {
      super(props);
      this.state = {
        accessToken: '',
        randomTrack: null,
        uniqueTracks: [],
        progress: 0,
      };
      this.users = ['userid', 'userid'];
      this.clientId = 'INSERT_CLIENT_ID';
      this.list = ['Nom Spotify des participants', 'Nom Spotify des participants'];
    }

    componentDidMount() {
      this.handleAuthResponse();
    }

    async handleAuthResponse () {
      // Check if the URL contains an access token in the fragment
      const params = new URLSearchParams(window.location.hash.substr(1));
      const accessToken = params.get('access_token');

      if (accessToken) {
        // You have the access token, you can now use it or store it
        this.setState({ accessToken: accessToken });
        await this.getRandomTrack(accessToken);
      }
    };

    async handleLogin() {
      const redirectUri = 'http://localhost:3000';

      const authUrl = `https://accounts.spotify.com/authorize?` +
        `client_id=${this.clientId}&` +
        `redirect_uri=${encodeURIComponent(redirectUri)}&` +
        `response_type=token&`;

      // Redirect the user to Spotify for authentication
      window.location.href = authUrl;
    };

    async loadTracks(accessToken) {
      const promises = this.users
        .map(user => axios.get(
          `https://api.spotify.com/v1/users/${user}/playlists`,
          {headers: {'Authorization': 'Bearer ' + accessToken}}
        )
      );
      const playlists = []
      const tracks = [];
      
      await Promise.all(promises)
        .then(responses => {
          responses.forEach(response => { playlists.push(...response.data.items) })
        });

      for (let i = 0; i < playlists.length; i++) {
        this.setState({progress: (i/playlists.length * 100)});
        const user = playlists[i].owner.display_name;        
        if (!this.list.includes(user)) continue;
        await axios.get(`${playlists[i].tracks.href}`, {headers: {'Authorization': 'Bearer ' + accessToken }})
          .then(response => 
            response.data.items.forEach(item => _.get(item, 'track.external_urls.spotify') && tracks.push({track: _.get(item, 'track.external_urls.spotify'), user}))
          );
      }

      const trackIds = tracks.map(t => t.track);
      const counter =  this.list.reduce((acc, user) => { acc[user] = 0; return acc; }, {});
      const uniqueTracks = tracks.filter((track, index) => {
        const listWithoutTrack = trackIds.splice(index, 1);
        counter[track.user] +=1;
        
        return !listWithoutTrack.includes(track.track) && counter[track.user] < 200
      });
      this.setState({ uniqueTracks });
      return uniqueTracks
    };

    async getRandomTrack(accessToken, stateUniqueTracks = []) {
      let test = stateUniqueTracks;
      if (stateUniqueTracks.length === 0) {
        const uniqueTracks = await this.loadTracks(accessToken);
        test = uniqueTracks;
      }
      const randomTrack = test[Math.floor(Math.random() * test.length)];
      randomTrack.track = randomTrack.track.replace('/track/', '/embed/track/');
      this.setState({ randomTrack });
    }

    render() {
      const { accessToken, randomTrack, uniqueTracks, progress } = this.state;
      if (!accessToken) return <button onClick={() => this.handleLogin()}>Login with Spotify</button>;

      return (
        <div className="container">
          {uniqueTracks.length ? (
            <div>
              {randomTrack ? 
                <div>
                  <h1>Track aléatoire</h1>
                  <div className="user-info">
                    <p>(Spoiler c'est dans la playlist de : <strong>{randomTrack.user}</strong>)</p>
                  </div>
                  <iframe src={`${randomTrack.track}?utm_source=oembeded"`} loading="lazy" width="100%" height="152" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>
                </div>
              : <div>
                <div className="loading">
                  <span className="spinner"></span> Chargement de la track aléatoire...
                </div>
              </div>
              }
              <button onClick={() => this.getRandomTrack(accessToken, uniqueTracks)}>New track</button>
            </div>
          ) : (
            <div>
              <div className="loading">
                <span className="spinner"></span>Chargement des playlists...
                </div>
                <p>{progress.toFixed(1)}%</p>
            </div>
          )}
        </div>
      );
    }
  }

  ReactDOM.render(<App />, document.getElementById('root'));
</script>

</body>
</html>
